<!DOCTYPE html>
<html>
  <head>
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
      html {
        height: 100%;
      }

      body {
        min-height: 100%;
      }

      html,
      body {
        background-color: #000;
        width: 100%;
        margin: 0;
        padding: 0;
        font-family: monospace;
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      .terminal {
        height: 100%;
        width: 100%;
        margin: 0 auto;
        color: #fff;
        overflow-y: scroll;
        padding: 20px;
      }

      .prompt {
        color: #0f0;
      }

      .form {
        display: flex;
        width: 100vw;
        margin: 0 auto;
      }

      .input {
        background-color: transparent;
        border: none;
        color: #fff;
        outline: none;
        flex-grow: 1;
      }

      .input::placeholder {
        color: #666;
      }

      label {
        width: 100%;
        white-space: nowrap;
        display: inline-flex;
      }

      .terminal p,
      .prompt,
      .input {
        font-family: monospace;
        font-size: 16px;
        white-space: pre-wrap;
      }
    </style>
  </head>
  <body>
    <div id="root"></div>
    <script type="module">
      function read_line(prompt) {
        console.log("called read_line: " + prompt);
        return "line";
      }

      function read_password(prompt) {
        console.log("called read_password: " + prompt);
        return "password";
      }

      import init, { ok_add, hel_init, hel_command } from "./pkg/helwasm.js";
      init().then(() => {
        window.hel = {
          ok_add: ok_add,
          hel_init: hel_init,
          hel_command: hel_command,
        }
      });
    </script>
    <script type="text/babel">
      function Terminal() {
        const [input, setInput] = React.useState("");
        const [output, setOutput] = React.useState([]);
        const outputRef = React.useRef(null);

        React.useEffect(() => {
          outputRef.current.scrollIntoView({ behaviour: "smooth" });
        }, [output]);
      
        function handleInput(event) {
          setInput(event.target.value);
        }
      
        function handleSubmit(event) {
          event.preventDefault();
          const result = executeCommand(input);
          setOutput([...output, { prompt: "‚ùØ", command: input }, { prompt: "", command: result }]);
          setInput("");
        }
      
        function executeCommand(command) {
      return window.hel.hel_command(command);
        }
      
        return (
          <div className="terminal">
            {output.map(({ prompt, command }, index) => (
              <p key={index}>{prompt && (<span className="prompt">&#x276f;&nbsp;</span>)}{command}</p>
            ))}
              <form onSubmit={handleSubmit}>
                <label>
                  <span className="prompt" ref={outputRef}>&#x276f;&nbsp;</span>
                  <input
                    type="text"
                    value={input}
                    onChange={handleInput}
                    className="input"
                    autoFocus
                  />
                </label>
              </form>
          </div>
        );
      }
  
      const container = document.getElementById('root');
      const root = ReactDOM.createRoot(container);
      root.render(<Terminal />);
    </script>
  </body>
</html>
